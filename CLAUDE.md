# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Important: Dogfooding Context

We are dogfooding Memento Protocol while developing it. This means:
- The **generator CLI source code** (src/, scripts/, templates/) is what we're developing
- The **generated .memento directory** contains our own project's modes/workflows/tickets
- The **generated .claude directory** contains Claude Code configuration generated by our CLI
- When making updates, always modify the CLI source code, then run `yarn dev init --force --non-interactive` to update our own dogfooding setup

**NEVER** confuse:
- Editing the CLI code (what we want) vs editing generated files (usually wrong)
- The Memento Protocol CLI commands vs Claude Code custom commands
- Templates in templates/ (source) vs installed components in .memento/ (generated)

## Commands

### Build and Development
```bash
# Install dependencies
npm install

# Build the project (bundles with esbuild, adds shebang, copies templates)
npm run build

# Development mode (run TypeScript directly)
npm run dev

# Watch mode for development
npm run watch

# Clean build artifacts
npm run clean
```

### Testing
```bash
# Run all tests
npm test

# Run tests with coverage (thresholds: 30% branches, 45% functions/lines/statements)
npm run test:coverage

# Run a specific test file
npx jest src/commands/__tests__/init.test.ts

# Run tests matching a pattern
npx jest --testNamePattern="should create ticket"
```

### Publishing
```bash
# Prepare for publishing (runs tests and build)
npm run prepublishOnly

# The actual publish is handled by scripts/npm/commit-tag-and-publish.sh
```

## Development CLI

### Non-Interactive Initialization
- To run the current development CLI non-interactively: `yarn dev init --force --non-interactive`
- This regenerates our dogfooding .memento and .claude directories

## Architecture

### Core Structure
Memento Protocol is a CLI tool that enhances Claude Code projects with advanced context management, custom commands, and AI agents.

**Key Concepts:**
- **Modes**: AI personalities optimized for specific tasks with fuzzy matching support
- **Workflows**: Reusable procedures for common development patterns
- **Agents**: Claude Code subagents for specialized tasks (e.g., claude-code-research)
- **Tickets**: State management for persistent task tracking
- **Hooks**: Claude Code integration points for automated behavior
- **Custom Commands**: Project-specific slash commands (/mode, /ticket, /memento)

### Directory Layout
```
src/
├── cli.ts                 # Main entry point, command registration
├── commands/              # CLI command implementations
│   ├── init.ts           # Initialize/update Memento Protocol
│   ├── add.ts            # Add modes/workflows/agents
│   ├── list.ts           # List available/installed components
│   ├── ticket.ts         # Ticket management (create/move/resolve)
│   ├── config.ts         # Configuration management
│   ├── update.ts         # Update components
│   ├── upsert.ts         # Combined init/update logic
│   └── command.ts        # Claude Code custom command generator
└── lib/                  # Core functionality
    ├── configManager.ts  # Config hierarchy (default->global->project->env)
    ├── ticketManager.ts  # Ticket lifecycle management
    ├── componentInstaller.ts # Install modes/workflows/agents
    ├── commandGenerator.ts # Generate Claude Code custom commands
    ├── projectDetector.ts # Detect project language/framework
    ├── upsertManager.ts  # Smart init/update logic
    └── hooks/            # Hook system implementation
        ├── HookManager.ts # Main hook orchestrator
        ├── HookRegistry.ts # Hook registration system
        └── builtin/      # Built-in hooks (routing, security, etc.)

templates/                # Component templates
├── modes/               # Built-in modes (architect, engineer, etc.)
├── workflows/           # Built-in workflows (review, summarize, etc.)
├── agents/              # Claude Code subagents (claude-code-research)
├── hooks/               # Hook templates and scripts
├── scripts/             # Utility scripts (mode-switch, ticket-context)
└── metadata.json        # Component metadata

Generated Directories:
.memento/                # Project-specific Memento data
├── modes/              # Installed mode definitions
├── workflows/          # Installed workflow definitions
├── tickets/            # Ticket storage (next/in-progress/done)
├── hooks/              # Hook configurations and scripts
├── scripts/            # Generated utility scripts
└── config.json         # Project configuration

.claude/                 # Claude Code configuration
├── agents/             # Installed Claude Code agents
├── commands/           # Custom slash commands
│   ├── mode.md        # Mode switching command
│   ├── ticket.md      # Ticket management command
│   └── memento.md     # Memento status command
└── settings.local.json # Claude Code project settings
```

### Key Design Patterns

1. **Command Pattern**: Each CLI command is a separate module with its own Command instance
2. **Manager Pattern**: Functionality is organized into manager classes (ConfigManager, TicketManager, HookManager, etc.)
3. **Template System**: Components are markdown/JSON templates that get copied and can be customized
4. **Hook System**: Modular Claude Code hooks with focused responsibilities
5. **Dual Directory Structure**: Separation between .memento (Memento data) and .claude (Claude Code config)

### Build Process
The build uses esbuild (scripts/build.js) to:
1. Bundle TypeScript into a single CLI executable
2. Inject version from package.json
3. Add shebang for direct execution
4. Copy templates to dist directory

### Testing Strategy
- Uses Jest with ts-jest preset
- Mocks inquirer for interactive testing
- Coverage thresholds enforced
- Tests organized alongside source files in __tests__ directories

### Error Handling
- Custom error types in lib/errors.ts
- Global error handlers in cli.ts
- Verbose/debug logging options for troubleshooting

### Component System

#### Modes
- AI personalities for different development tasks
- Support fuzzy matching: exact match → substring → acronym (e.g., `apm` → `autonomous-project-manager`)
- Stored as markdown in .memento/modes/
- Activated via `/mode [name]` custom command

#### Workflows
- Reusable development procedures and patterns
- Stored as markdown in .memento/workflows/
- Can be referenced in prompts or modes

#### Agents
- Claude Code subagents for specialized tasks
- Installed to .claude/agents/ directory
- Example: claude-code-research agent for Claude Code documentation
- Added via `memento add agent [name]`

#### Hooks
- Claude Code integration points for automated behavior
- Built-in hooks: memento-routing, security-guard, project-overview, git-context-loader
- Custom hooks can be added via templates
- Configured in .memento/hooks/definitions/

#### Custom Commands
- Project-specific slash commands generated in .claude/commands/
- `/mode` - Switch between modes with fuzzy matching
- `/ticket` - Manage tickets and load context
- `/memento` - Show project status

### Ticket Workflow
Tickets follow a lifecycle:
1. Created in `.memento/tickets/next/`
2. Moved to `.memento/tickets/in-progress/` when started
3. Moved to `.memento/tickets/done/` when completed
4. Can include context that gets injected into CLAUDE.md

## Development Guidelines

### Adding New Commands
1. Create command file in `src/commands/`
2. Export a Command instance
3. Register in `src/cli.ts`
4. Add tests in `src/commands/__tests__/`

### Adding New Components
1. Create template in appropriate `templates/` subdirectory:
   - Modes: markdown with personality/behavior instructions
   - Workflows: markdown with step-by-step procedures
   - Agents: markdown with frontmatter for tools and description
   - Hooks: JSON definition + shell script implementation
2. Update metadata.json with component metadata
3. Test installation via CLI commands
4. For agents, ensure proper .claude/agents/ targeting

### Hook Development
1. Create hook definition JSON in templates/hooks/
2. Create corresponding shell script
3. Define trigger events and configuration options
4. Test with real Claude Code interactions

### Code Style
- TypeScript with strict mode
- CommonJS modules for Node.js compatibility
- Async/await for asynchronous operations
- Comprehensive error messages for CLI users

### Dependencies
- commander: CLI framework
- inquirer: Interactive prompts
- esbuild: Build tool
- jest/ts-jest: Testing framework

## New Features (v0.7.0)

### Claude Code Subagent Support
- Complete implementation of subagent system
- CLI commands: `memento add agent`, `memento list agents`
- Agents install to `.claude/agents/` directory
- Built-in claude-code-research agent for documentation lookups

### Enhanced Mode Switching
- Fuzzy matching for mode names
- Supports exact match, substring match, and acronym shortcuts
- Example: `apm` automatically resolves to `autonomous-project-manager`
- Works via `/mode` custom command

### Custom Command System
- Generates Claude Code slash commands in `.claude/commands/`
- Proper permission format for Claude Code security model
- Commands: `/mode`, `/ticket`, `/memento`
- Shell script backend for dynamic behavior

### Improved Hook System
- Modular architecture with focused responsibilities
- Better error handling and validation
- Path-based trigger detection
- Intelligent context injection for tickets

### GitHub Integration
- Automated CI/CD workflow for Claude Code projects
- Proper integration with Claude Code's workflow patterns